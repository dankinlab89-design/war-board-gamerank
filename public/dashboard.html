<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard - WAR Board GameRank</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ============ CORRE√á√ïES E AJUSTES ============ */
        
        /* Estat√≠sticas R√°pidas - REMOVER M√âDIA/BATALHA */
        .dashboard-grid {
            grid-template-columns: repeat(3, 1fr) !important;
        }
        
        /* Ajustar altura dos cards de p√≥dio */
        .podium-container {
            min-height: 220px !important;
            margin-top: 10px !important;
            padding: 10px !important;
        }
        
        .podium-item.gold { height: 160px !important; }
        .podium-item.silver { height: 140px !important; }
        .podium-item.bronze { height: 130px !important; }
        
        .player-name {
            font-size: 1rem !important;
            color: #000 !important;
            font-weight: 800 !important;
        }
        
        /* Corrigir sobreposi√ß√£o de gr√°ficos */
        .charts-section {
            margin-top: 40px !important;
            clear: both !important;
        }
        
        .charts-section .dashboard-grid {
            display: grid !important;
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 20px !important;
        }
        
        .charts-section .dashboard-card {
            height: 100% !important;
            min-height: 300px !important;
        }
        
        .charts-section .card-body {
            height: 240px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .charts-section canvas {
            max-height: 220px !important;
            width: 100% !important;
        }
        
        /* Corrigir seletor de ano */
        .year-selector {
            display: flex !important;
            align-items: center !important;
            gap: 15px !important;
            margin: 15px 0 25px 0 !important;
            width: 100% !important;
        }
        
        .year-selector select {
            width: 150px !important;
            height: 40px !important;
            padding: 8px 12px !important;
            border-radius: 6px !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            font-family: 'Montserrat', sans-serif !important;
            font-size: 1rem !important;
        }
        
        .selector-info {
            color: rgba(255, 255, 255, 0.6) !important;
            font-size: 0.9rem !important;
            font-style: italic !important;
        }
        
        /* Vencedores - fonte mais clara */
        .vencedor-nome {
            color: #ffed4a !important; /* Amarelo mais claro */
            font-weight: 700 !important;
            font-size: 1.1rem !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3) !important;
        }
        
        .nome {
            color: #ffffff !important;
            font-weight: 600 !important;
        }
        
        /* Ranking 2025 - fonte mais clara */
        .ranking-item.gold .nome {
            color: #ffd700 !important;
            font-weight: 700 !important;
        }
        
        .ranking-item.silver .nome {
            color: #c0c0c0 !important;
            font-weight: 700 !important;
        }
        
        .ranking-item.bronze .nome {
            color: #cd7f32 !important;
            font-weight: 700 !important;
        }
        
        /* Tabs melhoradas */
        .tabs {
            margin-bottom: 15px !important;
        }
        
        .tab-btn {
            padding: 10px 20px !important;
            font-size: 0.9rem !important;
        }
        
        /* Espa√ßamento entre se√ß√µes */
        .rankings-section {
            margin-bottom: 40px !important;
        }
        
        .vencedores-section {
            margin-top: 40px !important;
        }
        
        /* Mensagens de erro mais vis√≠veis */
        .no-data-message {
            padding: 40px 20px !important;
            color: rgba(255, 255, 255, 0.7) !important;
            font-size: 1rem !important;
        }
        
        /* RESPONSIVIDADE */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .charts-section .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
            
            .podium-dashboard {
                flex-direction: column !important;
                align-items: center !important;
                gap: 15px !important;
            }
            
            .podium-item {
                width: 100% !important;
                max-width: 250px !important;
                height: auto !important;
                min-height: 120px !important;
                order: 0 !important;
            }
            
            .year-selector {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
        }
    </style>
</head>
<body>
    <!-- Navega√ß√£o -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="nav-logo">üìä</div>
                <h1>DASHBOARD <span class="nav-subtitle">WAR Board</span></h1>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Quartel</a>
                <a href="dashboard.html" class="nav-link active"><i class="fas fa-chart-bar"></i> Dashboard</a>
                <a href="jogadores.html" class="nav-link"><i class="fas fa-users"></i> Tropas</a>
                <a href="partidas.html" class="nav-link"><i class="fas fa-flag"></i> Batalhas</a>
                <a href="ranking.html" class="nav-link"><i class="fas fa-trophy"></i> Ranking</a>
                <a href="nova-partida-funcional.html" class="nav-btn"><i class="fas fa-plus"></i> Nova Batalha</a>
            </div>
            <button class="nav-toggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>
    
    <!-- Dashboard Container -->
    <main class="container">
        <!-- ============ ESTAT√çSTICAS R√ÅPIDAS ============ -->
        <section class="quick-stats">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-users"></i> TROPAS ATIVAS</h3>
                        <div class="card-icon">üë•</div>
                    </div>
                    <div class="card-body">
                        <div class="stat-number" id="stat-jogadores">0</div>
                        <div class="stat-trend" id="trend-jogadores">100% ativos</div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-flag"></i> BATALHAS TOTAL</h3>
                        <div class="card-icon">üéÆ</div>
                    </div>
                    <div class="card-body">
                        <div class="stat-number" id="stat-partidas">0</div>
                        <div class="stat-trend" id="trend-partidas">0% este m√™s</div>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-fire"></i> RECORDE CONSECUTIVAS</h3>
                        <div class="card-icon">üî•</div>
                    </div>
                    <div class="card-body">
                        <div class="stat-number" id="stat-record">0</div>
                        <div class="stat-label" id="record-holder">-</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============ P√ìDIOS DE BATALHA ============ -->
        <section class="rankings-section">
    <!-- P√≥dio Global -->
    <div class="container" style="margin-bottom: 60px;">
        <h2 class="section-title"><i class="fas fa-globe" style="margin-right: 10px;"></i>P√ìDIO GLOBAL</h2>
        <div class="podium" id="podium-global">
            <div class="no-data-message">Carregando p√≥dio global...</div>
        </div>
    </div>

    <!-- P√≥dio Mensal -->
    <div class="container" style="margin-bottom: 60px;">
        <h2 class="section-title"><i class="fas fa-calendar-alt" style="margin-right: 10px;"></i>P√ìDIO MENSAL</h2>
        <div class="podium" id="podium-mensal">
            <div class="no-data-message">Carregando p√≥dio mensal...</div>
        </div>
    </div>

    <!-- P√≥dio de Performance -->
    <div class="container">
        <h2 class="section-title"><i class="fas fa-bolt" style="margin-right: 10px;"></i>P√ìDIO DE PERFORMANCE</h2>
        <div class="podium" id="podium-performance">
            <div class="no-data-message">Carregando p√≥dio de performance...</div>
        </div>
    </div>
</section>

        <!-- ============ GR√ÅFICOS ============ -->
        <section class="charts-section">
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-pie"></i> DISTRIBUI√á√ÉO DE PATENTES</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="chart-patentes" height="200"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-chart-bar"></i> ASSIDUIDADE</h3>
                    </div>
                    <div class="card-body">
                        <canvas id="chart-assiduidade" height="200"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============ VENCEDORES MENSAIS ============ -->
        <section class="vencedores-section">
            <h2 class="section-title">VENCEDORES MENSAIS</h2>
            
            <div class="year-selector-container">
                <select id="select-ano" class="form-control">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                <span class="selector-info">Selecione o ano</span>
            </div>
            
            <div class="vencedores-grid" id="vencedores-grid">
                <div class="no-data-message">Carregando vencedores...</div>
            </div>
        </section>

        <!-- ============ √öLTIMAS PARTIDAS ============ -->
        <section class="partidas-section">
            <h2 class="section-title">√öLTIMAS 5 BATALHAS</h2>
            
            <div class="table-responsive">
                <table class="table" id="ultimas-partidas">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>VENCEDOR</th>
                            <th>TIPO</th>
                            <th>PARTICIPANTES</th>
                            <th>OBSERVA√á√ïES</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5);">
                                Carregando batalhas...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">üìä</div>
                    <h3>Dashboard WAR</h3>
                    <p>Sistema de an√°lise em tempo real</p>
                </div>
                
                <div class="footer-links">
                    <h4>AN√ÅLISE</h4>
                    <a href="dashboard.html">Dashboard</a>
                    <a href="ranking.html">Rankings</a>
                    <a href="estatisticas.html">Estat√≠sticas</a>
                </div>
                
                <div class="footer-export">
  <h4>EXPORTAR DADOS</h4>
  <div class="export-buttons">
    <button id="export-jogadores" class="export-btn military-btn">
      <i class="fas fa-file-csv military-icon"></i> Jogadores (CSV)
    </button>
    <button id="export-partidas" class="export-btn military-btn csv">
      <i class="fas fa-file-csv military-icon"></i> Batalhas (CSV)
    </button>
    <button id="export-estatisticas" class="export-btn military-btn json">
      <i class="fas fa-chart-bar military-icon"></i> Estat√≠sticas (CSV)
    </button>
  </div>
</div>

                                <div class="footer-info">
                    <h4>ATUALIZA√á√ÉO</h4>
                    <div class="status-indicator online">
                        <span class="status-dot"></span>
                        Sistema Online
                    </div>
                    <p>√öltima atualiza√ß√£o: <span id="last-update">Agora</span></p>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 WAR Board GameRank</p>
            </div>
        </div>
    </footer>

<!-- Scripts do Dashboard -->
<script src="js/dashboard-mongodb.js"></script>
<script src="js/ranking.js"></script>
<script>
    // Inicializar dashboard quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando Dashboard...');
        window.dashboard = new DashboardMongoDB();
    });
</script>
    
    <!-- ============ JAVASCRIPT CORRIGIDO ============ -->
    <script>
        // ============ CONFIGURA√á√ÉO ============
        const API_BASE = window.location.origin + '/api';
        let charts = {};
        let dadosJogadores = [];
        let dadosPartidas = [];
        
        // ============ INICIALIZA√á√ÉO ============
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard inicializando...');
            
            // Menu mobile
            document.querySelector('.nav-toggle').addEventListener('click', function() {
                document.querySelector('.nav-menu').classList.toggle('active');
            });
            
            // Popular anos
            popularSeletorAnos();
            
            // Carregar dados
            carregarTodosDados();
            
            // Auto-refresh
            setInterval(carregarDadosPrincipais, 30000);
            
            // Atualizar timestamp
            atualizarTimestamp();
            setInterval(atualizarTimestamp, 60000);
        });
        
        // ============ FUN√á√ïES PRINCIPAIS ============
        async function carregarTodosDados() {
            try {
                // Carregar dados b√°sicos primeiro
                await carregarDadosBasicos();
                
                // Depois carregar o resto
                await Promise.all([
                    carregarPodios(),
                    carregarVencedoresMensais(),
                    carregarUltimasPartidas()
                ]);
                
                // Finalmente os gr√°ficos
                await carregarGraficos();
                
                console.log('‚úÖ Todos os dados carregados');
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                mostrarNotificacao('Erro ao carregar dados do dashboard', 'error');
            }
        }
        
        async function carregarDadosBasicos() {
            try {
                const [jogadoresRes, partidasRes] = await Promise.all([
                    fetch(`${API_BASE}/jogadores`),
                    fetch(`${API_BASE}/partidas`)
                ]);
                
                const jogadoresData = await jogadoresRes.json();
                const partidasData = await partidasRes.json();
                
                // Guardar dados para uso posterior
                dadosJogadores = jogadoresData.jogadores || jogadoresData || [];
                dadosPartidas = partidasData.partidas || partidasData || [];
                
                // Atualizar estat√≠sticas
                atualizarEstatisticas();
                
            } catch (error) {
                console.error('Erro dados b√°sicos:', error);
            }
        }
        
        function carregarDadosPrincipais() {
            carregarDadosBasicos();
            carregarUltimasPartidas();
            atualizarTimestamp();
        }
        
        // ============ ESTAT√çSTICAS CORRIGIDAS ============
        function atualizarEstatisticas() {
            const totalJogadores = dadosJogadores.length;
            const totalPartidas = dadosPartidas.length;
            
            // Total de jogadores
            document.getElementById('stat-jogadores').textContent = totalJogadores;
            document.getElementById('trend-jogadores').textContent = '100% ativos';
            
            // Total de partidas
            document.getElementById('stat-partidas').textContent = totalPartidas;
            
            // Calcular % do m√™s atual
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const partidasEsteMes = dadosPartidas.filter(p => {
                const dataPartida = new Date(p.data);
                return dataPartida >= primeiroDiaMes;
            }).length;
            
            const percentualMes = totalPartidas > 0 ? 
                Math.round((partidasEsteMes / totalPartidas) * 100) : 0;
            document.getElementById('trend-partidas').textContent = `${percentualMes}% este m√™s`;
            
            // RECORDE CONSECUTIVAS - CALCULAR CORRETAMENTE
            const recordeConsecutivo = calcularRecordeConsecutivo();
            document.getElementById('stat-record').textContent = recordeConsecutivo.max;
            document.getElementById('record-holder').textContent = recordeConsecutivo.jogador;
        }
        
        // ============ CALCULAR RECORDE CONSECUTIVO ============
        function calcularRecordeConsecutivo() {
            let maxGeral = 0;
            let jogadorRecorde = '-';
            
            // Para cada jogador, calcular maior sequ√™ncia de vit√≥rias
            dadosJogadores.forEach(jogador => {
                // Filtrar partidas deste jogador
                const partidasJogador = dadosPartidas.filter(p => 
                    p.participantes && p.participantes.includes(jogador.apelido)
                ).sort((a, b) => new Date(a.data) - new Date(b.data));
                
                let sequenciaAtual = 0;
                let maxJogador = 0;
                
                // Verificar sequ√™ncia de vit√≥rias
                for (const partida of partidasJogador) {
                    if (partida.vencedor === jogador.apelido) {
                        sequenciaAtual++;
                        maxJogador = Math.max(maxJogador, sequenciaAtual);
                    } else {
                        sequenciaAtual = 0;
                    }
                }
                
                // Atualizar recorde geral
                if (maxJogador > maxGeral) {
                    maxGeral = maxJogador;
                    jogadorRecorde = jogador.apelido;
                }
            });
            
            return { max: maxGeral, jogador: jogadorRecorde };
        }
        
        // ============ P√ìDIOS CORRIGIDOS ============
        async function carregarPodios() {
            await Promise.all([
                carregarPodioGlobal(),
                carregarPodioMensal(),
                carregarPodioPerformance()
            ]);
        }
        
        function carregarPodioGlobal() {
            const container = document.getElementById('podium-global');
            if (!container || dadosJogadores.length === 0) {
                if (container) container.innerHTML = '<div class="no-data-message">Sem dados para p√≥dio global</div>';
                return;
            }
            
            // Ordenar por vit√≥rias
            const rankingGlobal = [...dadosJogadores]
                .filter(j => j.ativo !== false)
                .sort((a, b) => (b.vitorias || 0) - (a.vitorias || 0))
                .slice(0, 3);
            
            renderizarPodio(rankingGlobal, 'podium-global', 'vit√≥rias');
        }
        
        function carregarPodioMensal() {
            const container = document.getElementById('podium-mensal');
            if (!container) return;
            
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();
            
            // Filtrar partidas do m√™s atual
            const partidasMes = dadosPartidas.filter(p => {
                const data = new Date(p.data);
                return data.getMonth() + 1 === mesAtual && data.getFullYear() === anoAtual;
            });
            
            if (partidasMes.length === 0) {
                const mesNome = hoje.toLocaleDateString('pt-BR', { month: 'long' });
                container.innerHTML = `<div class="no-data-message">Nenhuma partida em ${mesNome}</div>`;
                return;
            }
            
            // Calcular vit√≥rias por jogador no m√™s
            const vitoriasPorJogador = {};
            
            partidasMes.forEach(partida => {
                if (partida.vencedor) {
                    vitoriasPorJogador[partida.vencedor] = (vitoriasPorJogador[partida.vencedor] || 0) + 1;
                }
            });
            
            // Converter para array e ordenar
            const rankingMensal = Object.entries(vitoriasPorJogador)
                .map(([apelido, vitorias]) => {
                    const jogador = dadosJogadores.find(j => j.apelido === apelido) || { apelido, patente: 'Cabo ü™ñ' };
                    return { ...jogador, vitorias };
                })
                .sort((a, b) => b.vitorias - a.vitorias)
                .slice(0, 3);
            
            renderizarPodio(rankingMensal, 'podium-mensal', 'vit√≥rias');
        }
        
        function carregarPodioPerformance() {
            const container = document.getElementById('podium-performance');
            if (!container || dadosJogadores.length === 0) {
                if (container) container.innerHTML = '<div class="no-data-message">Sem dados de performance</div>';
                return;
            }
            
            // Calcular performance (m√≠nimo 3 partidas)
            const jogadoresComPerformance = dadosJogadores
                .filter(j => (j.partidas || 0) >= 3)
                .map(j => {
                    const vitorias = j.vitorias || 0;
                    const partidas = j.partidas || 0;
                    const performance = partidas > 0 ? (vitorias / partidas * 100).toFixed(1) : 0;
                    return { ...j, performance };
                })
                .sort((a, b) => parseFloat(b.performance) - parseFloat(a.performance))
                .slice(0, 3);
            
            if (jogadoresComPerformance.length === 0) {
                container.innerHTML = '<div class="no-data-message">M√≠nimo 3 partidas para performance</div>';
                return;
            }
            
            renderizarPodioPerformance(jogadoresComPerformance);
        }
        
        function renderizarPodio(podio, containerId, tipo = 'vit√≥rias') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const podioCompleto = [
                podio[0] || null,
                podio[1] || null,
                podio[2] || null
            ];
            
            container.innerHTML = `
                <div class="podium-dashboard">
                    <div class="podium-item silver">
                        <div class="podium-rank">ü•à</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[1]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[1]?.vitorias || 0}</span> ${tipo}
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[1]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="podium-item gold">
                        <div class="podium-rank">ü•á</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[0]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[0]?.vitorias || 0}</span> ${tipo}
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[0]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="podium-item bronze">
                        <div class="podium-rank">ü•â</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[2]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[2]?.vitorias || 0}</span> ${tipo}
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[2]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderizarPodioPerformance(podio) {
            const container = document.getElementById('podium-performance');
            if (!container) return;
            
            const podioCompleto = [
                podio[0] || null,
                podio[1] || null,
                podio[2] || null
            ];
            
            container.innerHTML = `
                <div class="podium-dashboard">
                    <div class="podium-item silver">
                        <div class="podium-rank">ü•à</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[1]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[1]?.performance || 0}%</span>
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[1]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="podium-item gold">
                        <div class="podium-rank">ü•á</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[0]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[0]?.performance || 0}%</span>
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[0]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="podium-item bronze">
                        <div class="podium-rank">ü•â</div>
                        <div class="podium-player">
                            <div class="player-name">${podioCompleto[2]?.apelido || '-'}</div>
                            <div class="player-stats">
                                <span>${podioCompleto[2]?.performance || 0}%</span>
                            </div>
                            <div class="player-patente">
                                ${podioCompleto[2]?.patente || 'Cabo ü™ñ'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ============ VENCEDORES MENSAIS ============
        async function carregarVencedoresMensais() {
            const anoSelecionado = document.getElementById('select-ano')?.value || new Date().getFullYear();
            
            if (parseInt(anoSelecionado) === 2025) {
                mostrarRankingAnual2025();
                return;
            }
            
            renderizarVencedoresVazios(anoSelecionado);
        }
        
        function mostrarRankingAnual2025() {
            const grid = document.getElementById('vencedores-grid');
            if (!grid) return;
            
            grid.innerHTML = `
                <div class="ranking-anual-2025">
                    <div class="ano-card">
                        <div class="ano-header">
                            <h4>üèÜ 2025 - PRIMEIRO ANO üèÜ</h4>
                        </div>
                        <div class="ano-content">
                            <div class="ranking-item gold">
                                <span class="rank">ü•á</span>
                                <span class="nome">NEY2002</span>
                                <span class="vitorias">30 vit√≥rias</span>
                            </div>
                            <div class="ranking-item silver">
                                <span class="rank">ü•à</span>
                                <div class="empate-container">
                                    <div class="empate">
                                        <span class="nome">PetroIdeal</span>
                                        <span class="vitorias">22 vit√≥rias</span>
                                    </div>
                                    <div class="empate">
                                        <span class="nome">Daniel$80</span>
                                        <span class="vitorias">22 vit√≥rias</span>
                                    </div>
                                </div>
                            </div>
                            <div class="ranking-item bronze">
                                <span class="rank">ü•â</span>
                                <span class="nome">TucaRei</span>
                                <span class="vitorias">21 vit√≥rias</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderizarVencedoresVazios(ano) {
            const grid = document.getElementById('vencedores-grid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const meses = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            
            meses.forEach((mes, index) => {
                const mesNumero = index + 1;
                const card = document.createElement('div');
                card.className = 'mes-card';
                
                if (parseInt(ano) === 2025 && mesNumero <= new Date().getMonth() + 1) {
                    card.innerHTML = `
                        <div class="mes-header">
                            <h4>${mes.toUpperCase()}</h4>
                            <span class="mes-badge sem-dados">?</span>
                        </div>
                        <div class="mes-content">
                            <div class="sem-vencedor">Dados n√£o registrados</div>
                        </div>
                    `;
                } else if (parseInt(ano) < new Date().getFullYear() || 
                          (parseInt(ano) === new Date().getFullYear() && mesNumero <= new Date().getMonth() + 1)) {
                    card.innerHTML = `
                        <div class="mes-header">
                            <h4>${mes.toUpperCase()}</h4>
                            <span class="mes-badge sem-dados">?</span>
                        </div>
                        <div class="mes-content">
                            <div class="sem-vencedor">Dados n√£o dispon√≠veis</div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="mes-header">
                            <h4>${mes.toUpperCase()}</h4>
                            <span class="mes-badge futuro">‚û°Ô∏è</span>
                        </div>
                        <div class="mes-content">
                            <div class="sem-vencedor">Aguardando...</div>
                        </div>
                    `;
                }
                
                grid.appendChild(card);
            });
        }
        
        // ============ √öLTIMAS PARTIDAS ============
        async function carregarUltimasPartidas() {
            const tbody = document.querySelector('#ultimas-partidas tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (dadosPartidas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 30px; color: rgba(255,255,255,0.5);">
                            Nenhuma partida registrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            // √öltimas 5 partidas
            const ultimas = [...dadosPartidas]
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 5);
            
            ultimas.forEach(partida => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatarData(partida.data)}</td>
                    <td><strong style="color: #10b981;">${partida.vencedor}</strong></td>
                    <td><span class="badge ${getBadgeClass(partida.tipo)}">${partida.tipo || 'global'}</span></td>
                    <td>${partida.participantes?.length || 0}</td>
                    <td>${partida.observacoes || '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // ============ GR√ÅFICOS ============
        async function carregarGraficos() {
            try {
                await Promise.all([
                    carregarGraficoPatentes(),
                    carregarGraficoAssiduidade()
                ]);
            } catch (error) {
                console.error('Erro gr√°ficos:', error);
            }
        }
        
        function carregarGraficoPatentes() {
            const ctx = document.getElementById('chart-patentes');
            if (!ctx) return;
            
            // Destruir gr√°fico anterior
            if (charts.patentes) {
                charts.patentes.destroy();
            }
            
            if (dadosJogadores.length === 0) {
                ctx.parentElement.innerHTML = '<div class="sem-vencedor">Sem dados de patentes</div>';
                return;
            }
            
            // Contar patentes
            const contagem = {};
            dadosJogadores.forEach(j => {
                const patente = j.patente || 'Cabo ü™ñ';
                contagem[patente] = (contagem[patente] || 0) + 1;
            });
            
            const labels = Object.keys(contagem);
            const valores = Object.values(contagem);
            
            if (labels.length === 0) {
                ctx.parentElement.innerHTML = '<div class="sem-vencedor">Sem dados de patentes</div>';
                return;
            }
            
            charts.patentes = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: getCoresPatentes(labels),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                color: 'white', 
                                font: { size: 11 } 
                            } 
                        },
                        tooltip: { 
                            callbacks: { 
                                label: ctx => `${ctx.label}: ${ctx.raw} jogadores` 
                            } 
                        }
                    }
                }
            });
        }
        
        function carregarGraficoAssiduidade() {
            const ctx = document.getElementById('chart-assiduidade');
            if (!ctx) return;
            
            // Destruir gr√°fico anterior
            if (charts.assiduidade) {
                charts.assiduidade.destroy();
            }
            
            if (dadosJogadores.length === 0) {
                ctx.parentElement.innerHTML = '<div class="sem-vencedor">Sem dados de participa√ß√£o</div>';
                return;
            }
            
            // Top 8 por partidas
            const topJogadores = [...dadosJogadores]
                .sort((a, b) => (b.partidas || 0) - (a.partidas || 0))
                .slice(0, 8);
            
            const labels = topJogadores.map(j => j.apelido);
            const valores = topJogadores.map(j => j.partidas || 0);
            
            if (labels.length === 0) {
                ctx.parentElement.innerHTML = '<div class="sem-vencedor">Sem dados de participa√ß√£o</div>';
                return;
            }
            
            charts.assiduidade = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Participa√ß√µes',
                        data: valores,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: 'rgba(255,255,255,0.7)' }, 
                            grid: { color: 'rgba(255,255,255,0.1)' } 
                        },
                        x: { 
                            ticks: { 
                                color: 'rgba(255,255,255,0.7)', 
                                maxRotation: 45,
                                font: { size: 11 }
                            }, 
                            grid: { color: 'rgba(255,255,255,0.1)' } 
                        }
                    },
                    plugins: { 
                        legend: { 
                            labels: { 
                                color: 'white',
                                font: { size: 12 }
                            } 
                        } 
                    }
                }
            });
        }
        
        // ============ FUN√á√ïES AUXILIARES ============
        function getCoresPatentes(patentes) {
            const cores = [
                '#9ca3af', '#10b981', '#3b82f6', '#8b5cf6', '#f59e0b',
                '#ef4444', '#ec4899', '#6366f1', '#14b8a6', '#fbbf24',
                '#dc2626', '#ea580c', '#ca8a04', '#65a30d', '#16a34a'
            ];
            return patentes.map((_, i) => cores[i % cores.length]);
        }
        
        function formatarData(dataString) {
            try {
                const data = new Date(dataString);
                return data.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dataString;
            }
        }
        
        function getBadgeClass(tipo) {
            if (!tipo) return 'badge-secondary';
            
            const tipoLower = tipo.toLowerCase();
            if (tipoLower.includes('global')) return 'badge-primary';
            if (tipoLower.includes('campeonato')) return 'badge-warning';
            if (tipoLower.includes('amistosa')) return 'badge-info';
            if (tipoLower.includes('eliminatoria')) return 'badge-danger';
            return 'badge-secondary';
        }
        
        function popularSeletorAnos() {
            const select = document.getElementById('select-ano');
            if (!select) return;
            
            select.innerHTML = '';
            const anoAtual = new Date().getFullYear();
            
            // Adicionar anos de 2025 at√© atual + 1
            for (let ano = 2025; ano <= anoAtual + 1; ano++) {
                const option = document.createElement('option');
                option.value = ano;
                option.textContent = ano;
                select.appendChild(option);
            }
            
            select.value = anoAtual;
            
            // Adicionar listener
            select.addEventListener('change', carregarVencedoresMensais);
        }
        
        function atualizarTimestamp() {
            const elemento = document.getElementById('last-update');
            if (elemento) {
                elemento.textContent = new Date().toLocaleTimeString('pt-BR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        }
        
        function mostrarNotificacao(mensagem, tipo = 'success') {
            // Implementa√ß√£o simples de notifica√ß√£o
            console.log(`${tipo === 'error' ? '‚ùå' : '‚úÖ'} ${mensagem}`);
        }
        
        // ============ EXPORTA√á√ÉO ============
        document.addEventListener('click', async function(e) {
            if (e.target.closest('.export-btn')) {
                const btn = e.target.closest('.export-btn');
                const tipo = btn.id.replace('export-', '');
                
                try {
                    let data, filename;
                    
                    switch(tipo) {
                        case 'jogadores':
                            data = { jogadores: dadosJogadores };
                            filename = `jogadores-war-${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        case 'partidas':
                            data = { partidas: dadosPartidas };
                            filename = `partidas-war-${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        case 'estatisticas':
                            data = {
                                estatisticas: {
                                    total_jogadores: dadosJogadores.length,
                                    total_partidas: dadosPartidas.length,
                                    record_consecutivo: calcularRecordeConsecutivo().max,
                                    record_holder: calcularRecordeConsecutivo().jogador
                                }
                            };
                            filename = `estatisticas-war-${new Date().toISOString().split('T')[0]}.json`;
                            break;
                        default:
                            return;
                    }
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    mostrarNotificacao(`Dados exportados como ${filename}`);
                    
                } catch (error) {
                    console.error('Erro exporta√ß√£o:', error);
                    mostrarNotificacao('Erro ao exportar dados', 'error');
                }
            }
        });
        
        // ============ FUN√á√ïES DO TEMPLATE ============
        //window.switchTab = function(tabName) {
            // Remove active de todas as tabs
            //document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            //document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adiciona active na tab selecionada
            //const tabBtn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            //const tabContent = document.getElementById(`tab-${tabName}`);
            
            //if (tabBtn) tabBtn.classList.add('active');
            //if (tabContent) tabContent.classList.add('active');
        //};
        
        console.log('‚úÖ Dashboard corrigido e pronto!');
    </script>

    // Inicializar dashboard quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Inicializando Dashboard...');
        window.dashboard = new DashboardMongoDB();
    });
</script>
</body>
</html>




