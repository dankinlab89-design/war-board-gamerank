<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ûï Nova Batalha - WAR Board GameRank</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .jogadores-lista {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 300px;
            overflow-y: auto;
        }
        .jogador-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .jogador-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #b8860b;
        }
        .jogador-check {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .jogador-info {
            display: flex;
            align-items: center;
        }
        .jogador-nome {
            font-weight: bold;
            color: white;
        }
        .jogador-patente {
            margin-left: 10px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .status-box {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        .status-ok {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #28a745;
        }
        .status-error {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #dc3545;
        }
        .status-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <div class="nav-logo">‚ûï</div>
                <h1>NOVA BATALHA <span class="nav-subtitle">WAR Board</span></h1>
            </div>
            <div class="nav-menu">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Quartel</a>
                <a href="dashboard.html" class="nav-link"><i class="fas fa-chart-bar"></i> Dashboard</a>
                <a href="jogadores.html" class="nav-link"><i class="fas fa-users"></i> Tropas</a>
                <a href="partidas.html" class="nav-link"><i class="fas fa-flag"></i> Batalhas</a>
                <a href="ranking.html" class="nav-link"><i class="fas fa-trophy"></i> Ranking</a>
                <a href="nova-partida-funcional.html" class="nav-link active"><i class="fas fa-plus"></i> Nova Batalha</a>
            </div>
            <button class="nav-toggle"><i class="fas fa-bars"></i></button>
        </div>
    </nav>

    <main class="container">
        <div class="form-container">
            <h2 class="section-title">REGISTRAR NOVA BATALHA</h2>
            
            <div id="status" class="status-box" style="display: none;"></div>
            
            <form id="form-partida">
                <div class="form-group">
                    <label class="form-label">Data da Batalha:</label>
                    <input type="date" class="form-control" id="data" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Batalha:</label>
                    <select class="form-control" id="tipo" required>
                        <option value="global">Global üåé</option>
                        <option value="campeonato">Campeonato üèÜ</option>
                        <option value="amistosa">Amistosa ü§ù</option>
                        <option value="eliminatoria">Eliminat√≥ria ‚öîÔ∏è</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Selecione os Participantes (m√≠nimo 3):</label>
                    <div id="jogadores-loading">
                        <p><i class="fas fa-spinner fa-spin"></i> Carregando jogadores...</p>
                    </div>
                    <div id="jogadores-lista" class="jogadores-lista" style="display: none;"></div>
                    <div id="contador" class="status-warning status-box" style="margin-top: 15px;">
                        0 jogadores selecionados
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Vencedor:</label>
                    <select class="form-control" id="vencedor" required disabled>
                        <option value="">Primeiro selecione 3+ participantes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes:</label>
                    <textarea class="form-control" id="observacoes" rows="3" placeholder="Detalhes da batalha..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-lg" id="btn-submit" disabled>
                        <i class="fas fa-flag"></i> REGISTRAR BATALHA
                    </button>
                    <a href="partidas.html" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> VER BATALHAS
                    </a>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 WAR Board GameRank - Sistema de Batalhas</p>
            </div>
        </div>
    </footer>

    <script>
        // Menu mobile
        document.querySelector('.nav-toggle').addEventListener('click', function() {
            document.querySelector('.nav-menu').classList.toggle('active');
        });
        
        // Vari√°veis globais
        let jogadores = [];
        let selecionados = new Map(); // Usar Map para armazenar id -> apelido
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Data atual
            document.getElementById('data').value = new Date().toISOString().split('T')[0];
            
            // Carregar jogadores
            carregarJogadores();
            
            // Adicionar evento de clique aos itens de jogador (delega√ß√£o de eventos)
            document.getElementById('jogadores-lista').addEventListener('change', function(e) {
                if (e.target.classList.contains('jogador-check')) {
                    const jogadorId = e.target.value;
                    const jogador = jogadores.find(j => (j._id || j.id) === jogadorId);
                    if (jogador) {
                        atualizarSelecionados(jogadorId, jogador.apelido);
                    }
                }
            });
        });
        
        // Carregar jogadores do banco
        async function carregarJogadores() {
            try {
                mostrarStatus('Carregando jogadores...', 'warning');
                
                const response = await fetch('/api/jogadores');
                
                if (!response.ok) {
                    throw new Error('Erro na API: ' + response.status);
                }
                
                const data = await response.json();
                console.log('Resposta da API jogadores:', data);
                
                // Verificar diferentes formatos de resposta
                if (data.jogadores && Array.isArray(data.jogadores)) {
                    jogadores = data.jogadores.filter(j => j.ativo !== false);
                } else if (Array.isArray(data)) {
                    jogadores = data.filter(j => j.ativo !== false);
                } else if (data.success && Array.isArray(data.jogadores)) {
                    jogadores = data.jogadores.filter(j => j.ativo !== false);
                } else {
                    throw new Error('Formato de resposta inv√°lido');
                }
                
                if (jogadores.length === 0) {
                    mostrarStatus('Nenhum jogador cadastrado. Cadastre jogadores primeiro.', 'error');
                    return;
                }
                
                // Esconder loading, mostrar lista
                document.getElementById('jogadores-loading').style.display = 'none';
                const lista = document.getElementById('jogadores-lista');
                lista.style.display = 'block';
                
                // Adicionar jogadores √† lista
                lista.innerHTML = '';
                jogadores.forEach(jogador => {
                    const jogadorId = jogador._id || jogador.id;
                    const div = document.createElement('div');
                    div.className = 'jogador-item';
                    div.innerHTML = `
                        <div class="jogador-info">
                            <input type="checkbox" 
                                   class="jogador-check" 
                                   value="${escapeHtml(jogadorId)}"
                                   id="jogador-${escapeHtml(jogadorId)}">
                            <div>
                                <div class="jogador-nome">${escapeHtml(jogador.apelido)}</div>
                                <div class="jogador-patente">${escapeHtml(jogador.patente || 'Cabo ü™ñ')}</div>
                            </div>
                        </div>
                    `;
                    lista.appendChild(div);
                });
                
                mostrarStatus(`${jogadores.length} jogadores carregados`, 'ok');
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarStatus('Erro ao carregar jogadores: ' + error.message, 'error');
            }
        }
        
        // Fun√ß√£o para escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Atualizar lista de selecionados
        function atualizarSelecionados(jogadorId, jogadorApelido) {
            const checkbox = document.getElementById(`jogador-${jogadorId}`);
            
            if (checkbox.checked) {
                selecionados.set(jogadorId, jogadorApelido);
            } else {
                selecionados.delete(jogadorId);
            }
            
            // Atualizar contador
            const contador = document.getElementById('contador');
            contador.textContent = `${selecionados.size} jogadores selecionados`;
            
            if (selecionados.size < 3) {
                contador.className = 'status-error status-box';
                document.getElementById('vencedor').disabled = true;
                document.getElementById('btn-submit').disabled = true;
                document.getElementById('vencedor').innerHTML = '<option value="">Selecione 3+ participantes primeiro</option>';
            } else {
                contador.className = 'status-ok status-box';
                atualizarVencedores();
                document.getElementById('vencedor').disabled = false;
                document.getElementById('btn-submit').disabled = false;
            }
        }
        
        // Atualizar lista de vencedores
        function atualizarVencedores() {
            const select = document.getElementById('vencedor');
            select.innerHTML = '<option value="">Selecione o vencedor</option>';
            
            // Converter Map para array e ordenar por apelido
            const jogadoresArray = Array.from(selecionados.entries())
                .map(([id, apelido]) => ({ id, apelido }))
                .sort((a, b) => a.apelido.localeCompare(b.apelido));
            
            jogadoresArray.forEach(jogador => {
                const option = document.createElement('option');
                option.value = jogador.apelido;
                option.textContent = `${jogador.apelido}`;
                select.appendChild(option);
            });
        }
        
        // Enviar formul√°rio
        document.getElementById('form-partida').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selecionados.size < 3) {
                mostrarStatus('Selecione pelo menos 3 participantes!', 'error');
                return;
            }
        
            const vencedorApelido = document.getElementById('vencedor').value;
            if (!vencedorApelido) {
                mostrarStatus('Selecione um vencedor!', 'error');
                return;
            }
            
            // Converter Map para array de apelidos
            const participantesApelidos = Array.from(selecionados.values());
            
            // Verificar se o vencedor est√° entre os participantes
            if (!participantesApelidos.includes(vencedorApelido)) {
                mostrarStatus('O vencedor deve estar entre os participantes selecionados!', 'error');
                return;
            }
            
            const partida = {
                data: document.getElementById('data').value,
                tipo: document.getElementById('tipo').value,
                vencedor: vencedorApelido,
                participantes: participantesApelidos,
                observacoes: document.getElementById('observacoes').value || '',
                pontos: 100
            };
            
            console.log('Enviando partida:', partida);
            
            try {
                mostrarStatus('Registrando partida...', 'warning');
                
                const response = await fetch('/api/partidas', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(partida)
                });
                
                const result = await response.json();
                
                console.log('Resposta do servidor:', result);
                
                if (response.ok && result.success) {
                    mostrarStatus('‚úÖ Partida registrada com sucesso!', 'ok');
                    
                    // Verificar se houve promo√ß√£o
                    if (result.promocao && result.promocao.promovido) {
                        // Mostrar mensagem extra de promo√ß√£o
                        const promoMsg = `üéñÔ∏è ${result.promocao.apelido} foi promovido para ${result.promocao.nova}!`;
                        mostrarStatus(promoMsg, 'ok');
                        
                        // Mostrar alerta simples
                        setTimeout(() => {
                            alert(`üéñÔ∏è PROMO√á√ÉO!\n\n${result.promocao.apelido} foi promovido:\n${result.promocao.antiga} ‚Üí ${result.promocao.nova}\n\nCom ${result.promocao.vitorias} vit√≥rias!`);
                        }, 1000);
                    }
                    
                    // Limpar formul√°rio ap√≥s 2 segundos
                    setTimeout(() => {
                        limparFormulario();
                    }, 2000);
                    
                } else {
                    mostrarStatus('Erro: ' + (result.error || 'Falha no registro'), 'error');
                }
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarStatus('Erro de conex√£o: ' + error.message, 'error');
            }
        });
        
        // Fun√ß√£o para limpar formul√°rio
        function limparFormulario() {
            // Desmarcar todos checkboxes
            document.querySelectorAll('.jogador-check:checked').forEach(cb => {
                cb.checked = false;
            });
            
            // Limpar selecionados
            selecionados.clear();
            
            // Resetar controles
            document.getElementById('observacoes').value = '';
            document.getElementById('vencedor').innerHTML = '<option value="">Selecione 3+ participantes primeiro</option>';
            document.getElementById('vencedor').disabled = true;
            document.getElementById('btn-submit').disabled = true;
            
            // Atualizar contador
            document.getElementById('contador').textContent = '0 jogadores selecionados';
            document.getElementById('contador').className = 'status-warning status-box';
        }
        
        // Fun√ß√£o para mostrar status
        function mostrarStatus(mensagem, tipo) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = mensagem;
            statusDiv.className = `status-box status-${tipo}`;
            statusDiv.style.display = 'block';
            
            if (tipo === 'ok') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Fun√ß√µes para selecionar/deselecionar todos
        function selecionarTodos() {
            const checkboxes = document.querySelectorAll('.jogador-check');
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.checked = true;
                    const jogadorId = cb.value;
                    const jogador = jogadores.find(j => (j._id || j.id) === jogadorId);
                    if (jogador) {
                        atualizarSelecionados(jogadorId, jogador.apelido);
                    }
                }
            });
        }
        
        function deselecionarTodos() {
            const checkboxes = document.querySelectorAll('.jogador-check:checked');
            checkboxes.forEach(cb => {
                cb.checked = false;
                const jogadorId = cb.value;
                const jogador = jogadores.find(j => (j._id || j.id) === jogadorId);
                if (jogador) {
                    atualizarSelecionados(jogadorId, jogador.apelido);
                }
            });
        }
        
        // Adicionar bot√µes de sele√ß√£o
        setTimeout(() => {
            const lista = document.getElementById('jogadores-lista');
            if (lista) {
                const botoesDiv = document.createElement('div');
                botoesDiv.style.marginBottom = '10px';
                botoesDiv.innerHTML = `
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="selecionarTodos()">
                        <i class="fas fa-check-double"></i> Selecionar Todos
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselecionarTodos()" style="margin-left: 10px;">
                        <i class="fas fa-times"></i> Desmarcar Todos
                    </button>
                `;
                lista.parentNode.insertBefore(botoesDiv, lista);
            }
        }, 100);
    </script>
</body>
</html>
