// Substitua TODO o script no seu HTML por esta vers√£o corrigida:

<script>
    // Vari√°veis globais
    let partidas = [];
    let todosJogadores = [];
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
        // Menu mobile
        const navToggle = document.querySelector('.nav-toggle');
        const navMenu = document.querySelector('.nav-menu');
        
        if (navToggle && navMenu) {
            navToggle.addEventListener('click', function() {
                navMenu.classList.toggle('active');
            });
        }
        
        // Carregar dados
        carregarJogadores();
        carregarPartidas();
        
        // Event Listeners
        document.getElementById('btn-recarregar').addEventListener('click', carregarPartidas);
        document.getElementById('btn-exportar').addEventListener('click', exportarCSV);
        document.getElementById('form-editar').addEventListener('submit', salvarEdicao);
        
        // Delega√ß√£o de eventos para os bot√µes din√¢micos
        document.getElementById('lista-partidas').addEventListener('click', function(e) {
            const target = e.target;
            
            // Bot√£o de editar
            if (target.classList.contains('btn-editar') || target.closest('.btn-editar')) {
                const btn = target.classList.contains('btn-editar') ? target : target.closest('.btn-editar');
                const partidaId = btn.dataset.id;
                if (partidaId) {
                    abrirEdicao(partidaId);
                }
            }
            
            // Bot√£o de excluir
            if (target.classList.contains('btn-excluir') || target.closest('.btn-excluir')) {
                const btn = target.classList.contains('btn-excluir') ? target : target.closest('.btn-excluir');
                const partidaId = btn.dataset.id;
                if (partidaId) {
                    confirmarExclusao(partidaId);
                }
            }
        });
    });
    
    // Carregar jogadores
    async function carregarJogadores() {
        try {
            const response = await fetch('/api/jogadores');
            const data = await response.json();
            
            if (data.success && data.jogadores) {
                todosJogadores = data.jogadores.filter(j => j.ativo !== false);
            }
        } catch (error) {
            console.error('Erro ao carregar jogadores:', error);
        }
    }
    
    // Carregar partidas
    async function carregarPartidas() {
        try {
            console.log('üîÑ Iniciando carregamento de partidas...');
            mostrarCarregando(true);
            esconderMensagem();
            
            const response = await fetch('/api/partidas');
            
            console.log('üì• Resposta da API (status):', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä Dados recebidos:', data);
            
            if (data.success) {
                partidas = data.partidas || [];
                console.log(`üéØ ${partidas.length} partidas carregadas`);
                renderizarPartidas(partidas);
            } else {
                console.error('‚ùå API retornou success: false', data);
                throw new Error(data.error || 'Erro desconhecido na API');
            }
            
        } catch (error) {
            console.error('‚ùå Erro completo ao carregar partidas:', error);
            mostrarMensagem('Erro ao carregar batalhas: ' + error.message, 'error');
            mostrarCarregando(false);
        }
    }
    
    // Renderizar partidas na tabela
    function renderizarPartidas(partidasLista) {
        const loading = document.getElementById('loading');
        const tabelaContainer = document.getElementById('tabela-container');
        const semDados = document.getElementById('sem-dados');
        const tbody = document.getElementById('lista-partidas');
        
        if (loading) loading.style.display = 'none';
        
        if (!partidasLista || partidasLista.length === 0) {
            if (semDados) semDados.style.display = 'block';
            if (tabelaContainer) tabelaContainer.style.display = 'none';
            return;
        }
        
        if (semDados) semDados.style.display = 'none';
        if (tabelaContainer) tabelaContainer.style.display = 'block';
        
        if (tbody) {
            tbody.innerHTML = '';
            
            // Ordenar por data (mais recente primeiro)
            partidasLista.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            partidasLista.forEach(partida => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatarData(partida.data)}</td>
                    <td>
                        <span class="badge ${getBadgeClass(partida.tipo)}">
                            ${partida.tipo || 'global'}
                        </span>
                    </td>
                    <td>
                        <strong style="color: #10b981;">
                            ${partida.vencedor}
                        </strong>
                    </td>
                    <td>${formatarParticipantes(partida.participantes)}</td>
                    <td>${partida.observacoes || '-'}</td>
                    <td class="acoes-cell">
                        <div class="btn-group-sm">
                            <button class="btn btn-warning btn-editar" data-id="${partida._id}" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-excluir" data-id="${partida._id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        mostrarCarregando(false);
    }
    
    // Abrir modal de edi√ß√£o
    async function abrirEdicao(partidaId) {
        try {
            console.log('üìù Abrindo edi√ß√£o da partida:', partidaId);
            
            const response = await fetch(`/api/partidas/${partidaId}`);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Resposta da API (edi√ß√£o):', data);
            
            if (data.success) {
                const partida = data.partida;
                
                // Preencher formul√°rio
                document.getElementById('partida-id').value = partida._id;
                
                // Formatar data para input (YYYY-MM-DD)
                const dataObj = new Date(partida.data);
                const dataFormatada = dataObj.toISOString().split('T')[0];
                document.getElementById('editar-data').value = dataFormatada;
                
                document.getElementById('editar-tipo').value = partida.tipo || 'global';
                document.getElementById('editar-vencedor').value = partida.vencedor;
                document.getElementById('editar-observacoes').value = partida.observacoes || '';
                
                // Mostrar participantes
                const participantesDiv = document.getElementById('participantes-info');
                if (participantesDiv) {
                    let html = '';
                    if (Array.isArray(partida.participantes)) {
                        partida.participantes.forEach(participante => {
                            html += `<span class="jogador-tag">${participante}</span> `;
                        });
                    } else if (typeof partida.participantes === 'string') {
                        partida.participantes.split(',').forEach(participante => {
                            if (participante.trim()) {
                                html += `<span class="jogador-tag">${participante.trim()}</span> `;
                            }
                        });
                    }
                    participantesDiv.innerHTML = html || 'Nenhum participante';
                }
                
                // Mostrar modal
                document.getElementById('modal-edicao').style.display = 'block';
            } else {
                throw new Error(data.error || 'Erro desconhecido na API');
            }
        } catch (error) {
            console.error('‚ùå Erro ao abrir edi√ß√£o:', error);
            mostrarMensagem('Erro ao carregar partida para edi√ß√£o: ' + error.message, 'error');
        }
    }
    
    // Fechar modal
    function fecharModal() {
        document.getElementById('modal-edicao').style.display = 'none';
    }
    
    // Salvar edi√ß√£o
    async function salvarEdicao(e) {
        e.preventDefault();
        
        const partidaId = document.getElementById('partida-id').value;
        const dados = {
            data: document.getElementById('editar-data').value,
            tipo: document.getElementById('editar-tipo').value,
            vencedor: document.getElementById('editar-vencedor').value,
            observacoes: document.getElementById('editar-observacoes').value
        };
        
        console.log('üíæ Salvando edi√ß√£o da partida:', partidaId, dados);
        
        try {
            const response = await fetch(`/api/partidas/${partidaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dados)
            });
            
            const result = await response.json();
            console.log('Resposta do servidor (edi√ß√£o):', result);
            
            if (result.success) {
                mostrarMensagem('‚úÖ Partida atualizada com sucesso!', 'success');
                fecharModal();
                carregarPartidas();
            } else {
                mostrarMensagem('Erro: ' + (result.error || 'Falha na atualiza√ß√£o'), 'error');
            }
        } catch (error) {
            console.error('‚ùå Erro ao salvar edi√ß√£o:', error);
            mostrarMensagem('Erro ao salvar altera√ß√µes: ' + error.message, 'error');
        }
    }
    
    // Confirmar exclus√£o
    function confirmarExclusao(partidaId) {
        const partida = partidas.find(p => p._id === partidaId);
        if (!partida) return;
        
        const confirmacao = confirm(`Tem certeza que deseja excluir esta batalha?\n\nData: ${formatarData(partida.data)}\nVencedor: ${partida.vencedor}\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita e afetar√° as estat√≠sticas dos jogadores!`);
        
        if (confirmacao) {
            excluirPartida(partidaId);
        }
    }
    
    // Excluir partida
    async function excluirPartida(partidaId) {
        try {
            console.log('üóëÔ∏è Excluindo partida:', partidaId);
            
            const response = await fetch(`/api/partidas/${partidaId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            console.log('Resposta do servidor (exclus√£o):', result);
            
            if (result.success) {
                mostrarMensagem('‚úÖ Partida exclu√≠da com sucesso!', 'success');
                carregarPartidas();
            } else {
                mostrarMensagem('Erro: ' + (result.error || 'Falha na exclus√£o'), 'error');
            }
        } catch (error) {
            console.error('‚ùå Erro ao excluir partida:', error);
            mostrarMensagem('Erro ao excluir partida: ' + error.message, 'error');
        }
    }
    
    // Exportar para CSV
    function exportarCSV() {
        if (partidas.length === 0) {
            mostrarMensagem('Nenhuma partida para exportar', 'error');
            return;
        }
        
        // Cabe√ßalho simplificado
        let csv = 'Data,Tipo,Vencedor,Participantes,Observa√ß√µes\n';
        
        // Dados
        partidas.forEach(partida => {
            const dataFormatada = formatarDataParaCSV(partida.data);
            const tipo = partida.tipo || 'global';
            const vencedor = partida.vencedor || '';
            
            // Formatar participantes
            let participantes = '';
            if (Array.isArray(partida.participantes)) {
                participantes = partida.participantes.join('; ');
            } else if (typeof partida.participantes === 'string') {
                participantes = partida.participantes;
            }
            
            // Escapar aspas para CSV
            const observacoes = (partida.observacoes || '').replace(/"/g, '""');
            
            // Linha CSV
            csv += `"${dataFormatada}","${tipo}","${vencedor}","${participantes}","${observacoes}"\n`;
        });
        
        // Criar e baixar arquivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `batalhas_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        mostrarMensagem('‚úÖ CSV exportado com sucesso!', 'success');
    }
    
    // Fun√ß√µes auxiliares
    function formatarData(dataString) {
        if (!dataString) return '-';
        try {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' + 
                   data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        } catch {
            return dataString;
        }
    }
    
    function formatarDataParaCSV(dataString) {
        if (!dataString) return '';
        try {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR') + ' ' + 
                   data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        } catch {
            return dataString;
        }
    }
    
    function formatarParticipantes(participantes) {
        if (!participantes) return '0';
        if (Array.isArray(participantes)) {
            return `${participantes.length} jogador(es)`;
        } else if (typeof participantes === 'string') {
            return `${participantes.split(',').length} jogador(es)`;
        }
        return '1+';
    }
    
    function getBadgeClass(tipo) {
        const classes = {
            'global': 'badge-primary',
            'campeonato': 'badge-warning',
            'amistosa': 'badge-info',
            'eliminatoria': 'badge-danger'
        };
        return classes[tipo] || 'badge-secondary';
    }
    
    function mostrarCarregando(mostrar) {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = mostrar ? 'block' : 'none';
        }
    }
    
    function mostrarMensagem(texto, tipo = 'info') {
        const container = document.getElementById('status-message');
        if (container) {
            container.innerHTML = `
                <div class="message message-${tipo}">
                    ${texto}
                </div>
            `;
            
            // Auto-remover ap√≥s 5 segundos para sucesso
            if (tipo === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 5000);
            }
        }
    }
    
    function esconderMensagem() {
        const container = document.getElementById('status-message');
        if (container) {
            container.innerHTML = '';
        }
    }
    
    // Fechar modal ao clicar fora
    window.addEventListener('click', function(e) {
        const modal = document.getElementById('modal-edicao');
        if (e.target === modal) {
            fecharModal();
        }
    });
</script>
